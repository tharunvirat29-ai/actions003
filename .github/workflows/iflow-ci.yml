name: Full iFlow CI/CD Pipeline

on:
  push:
    branches: [main]

jobs:
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      # Check for required XPath in iFlow definition
      - name: Check for correct XPath
        run: |
          if ! grep "/Order/OrderID" src/main/resources/scenarioflows/integrationflow/ci001.iflw; then
            echo "❌ Missing /Order/OrderID in ci001.iflw"
            exit 1
          fi
          echo "✅ XPath check passed"

      # Check naming convention in MANIFEST
      - name: Check naming convention
        run: |
          if ! grep -E "^Bundle-Name: ci[0-9]+" META-INF/MANIFEST.MF; then
            echo "❌ Bundle-Name must start with 'ci' followed by digits (e.g., ci001)"
            exit 1
          fi
          echo "✅ Bundle-Name naming convention passed"

  integration-test:
    name: Live Integration Test
    runs-on: ubuntu-latest
    needs: static-analysis
    steps:
      - name: Get OAuth token
        run: |
          TOKEN=$(curl -s --request POST \
            "${{ secrets.CPI_URL }}" \
            --header "Content-Type: application/x-www-form-urlencoded" \
            --data "grant_type=client_credentials&client_id=${{ secrets.CPI_CLIENT_ID }}&client_secret=${{ secrets.CPI_CLIENT_SECRET }}" \
            | jq -r '.access_token')

          if [ "$TOKEN" = "null" ] || [ -z "$TOKEN" ]; then
            echo "❌ Failed to retrieve access token"
            exit 1
          fi

          echo "TOKEN=$TOKEN" >> $GITHUB_ENV
          echo "✅ OAuth token retrieved"

      - name: Send test message to iFlow
        run: |
          curl --request POST "${{ secrets.IFLOW_URL }}" \
          --header "Authorization: Bearer $TOKEN" \
          --header "Content-Type: text/plain" \
          --data "tharun" \
          --output response.xml --fail

      - name: Check iFlow response
        run: |
          if ! grep "<name>tharun</name>" response.xml; then
            echo "❌ iFlow response does not contain expected output"
            cat response.xml
            exit 1
          fi
          echo "✅ iFlow response check passed"

