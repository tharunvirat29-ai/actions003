name: Full iFlow CI/CD Pipeline

on:
  push:
    branches: [main]

jobs:
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Check for correct XPath
        run: grep "/Order/OrderID" src/main/resources/scenarioflows/integrationflow/ci001.iflw
      
      - name: Check naming convention
        run: grep "Bundle-Name: ci" META-INF/MANIFEST.MF

  integration-test:
    name: Live Integration Test
    runs-on: ubuntu-latest
    needs: static-analysis
    steps:
      - name: Send test message to iFlow
        run: |
          curl --request POST '${{ secrets.IFLOW_ENDPOINT_URL }}' \
          --user '${{ secrets.CPI_USERNAME }}:${{ secrets.CPI_PASSWORD }}' \
          --header 'Content-Type: application/xml' \
          --data '<Order><OrderID>tharun</OrderID></Order>' \
          --output response.xml --fail
      
      - name: Check iFlow response
        run: grep "<name>tharun</name>" response.xml
